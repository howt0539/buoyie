<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡ªç”±æ½›æ°´åˆ†é… v15.0 (é€£ç·šæˆåŠŸç‰ˆ)</title>
    <style>
        /* --- æ¨£å¼è¨­å®š (èˆ‡ v14 ç›¸åŒ) --- */
        :root { --bg-color: #f0f4f8; --card-bg: #ffffff; --primary: #007bff; --danger: #dc3545; --success: #28a745; --info: #17a2b8; --warning: #ffc107; --purple: #6f42c1; --border: #dfe3e8; --coach-color: #ffebee; --coach-border: #ef9a9a; --high-color: #e8eaf6; --high-border: #9fa8da; --mid-color: #e3f2fd; --mid-border: #90caf9; --low-color: #e0f2f1; --low-border: #80cbc4; --newbie-color: #f5f5f5; --newbie-border: #bdbdbd; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: var(--bg-color); margin: 0; padding: 20px; color: #333; overscroll-behavior-y: contain; }
        h1 { text-align: center; color: #2c3e50; margin-bottom: 20px; }
        button { padding: 10px 14px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: opacity 0.2s; font-size: 14px; -webkit-user-select: none; user-select: none; }
        button:hover { opacity: 0.9; }
        .btn-primary { background-color: var(--primary); color: white; } .btn-success { background-color: var(--success); color: white; } .btn-danger { background-color: var(--danger); color: white; } .btn-info { background-color: var(--info); color: white; } .btn-purple { background-color: var(--purple); color: white; } .btn-reset { background-color: #6c757d; color: white; } .btn-manage { background-color: #2c3e50; color: white; margin-right: 10px; }
        .controls { background: var(--card-bg); padding: 15px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); display: flex; flex-wrap: wrap; gap: 15px; align-items: center; justify-content: center; margin-bottom: 20px; }
        .control-group { display: flex; align-items: center; gap: 8px; }
        select.logic-select { padding: 8px; border-radius: 6px; border: 1px solid var(--border); font-size: 16px; background-color: #fff; cursor: pointer; height: 40px; }
        .stepper { display: flex; align-items: center; border: 1px solid var(--border); border-radius: 6px; overflow: hidden; background: #fff; }
        .stepper input { border: none; width: 50px; text-align: center; font-size: 16px; padding: 0; height: 38px; -moz-appearance: textfield; }
        .stepper input::-webkit-outer-spin-button, .stepper input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .stepper-btns { display: flex; flex-direction: column; border-left: 1px solid var(--border); }
        .stepper-btn { width: 24px; height: 19px; background: #f8f9fa; border: none; border-bottom: 1px solid var(--border); cursor: pointer; font-size: 10px; padding: 0; display: flex; align-items: center; justify-content: center; color: #555; }
        .stepper-btn:last-child { border-bottom: none; } .stepper-btn:hover { background: #e2e6ea; } .stepper-btn:active { background: #dae0e5; }
        .buoy-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; padding-bottom: 50px; }
        .buoy { background: var(--card-bg); border-radius: 12px; border: 2px solid transparent; box-shadow: 0 4px 6px rgba(0,0,0,0.05); display: flex; flexDirection: column; overflow: hidden; transition: all 0.2s; }
        .buoy.drag-over { border-color: var(--primary); background-color: #f0f7ff; }
        .buoy-header { background: #2c3e50; color: white; padding: 12px; display: flex; justify-content: space-between; align-items: center; }
        .buoy-stats { padding: 8px 12px; background: #ecf0f1; font-size: 0.9em; text-align: right; border-bottom: 1px solid var(--border); }
        .buoy-stats.over-limit { color: #c62828; font-weight: bold; background: #ffcdd2; }
        .diver-list { padding: 10px; min-height: 100px; flex-grow: 1; }
        .diver-card { padding: 12px 10px; margin-bottom: 8px; border-radius: 8px; border: 1px solid #ccc; cursor: grab; display: flex; justify-content: space-between; align-items: center; user-select: none; position: relative; touch-action: none; }
        .diver-card:active { cursor: grabbing; transform: scale(1.02); }
        .rank-5 { background: var(--coach-color); border-color: var(--coach-border); } .rank-4 { background: var(--high-color); border-color: var(--high-border); } .rank-3 { background: var(--mid-color); border-color: var(--mid-border); } .rank-2 { background: var(--low-color); border-color: var(--low-border); } .rank-1 { background: var(--newbie-color); border-color: var(--newbie-border); color: #666; }
        .diver-info { display: flex; align-items: center; gap: 8px; white-space: nowrap; overflow: hidden; }
        .leader-icon { cursor: pointer; font-size: 1.4em; color: #ccc; padding: 0 5px; } .is-auto-leader .leader-icon { color: #f1c40f; } .is-manual-leader .leader-icon { color: #ff5722; text-shadow: 0 0 2px rgba(0,0,0,0.2); }
        .mobile-move { display: none; font-size: 0.9em; padding: 5px 10px; background:rgba(0,123,255,0.1); border-radius:4px; color: #007bff; cursor: pointer; margin-left: auto; white-space: nowrap;} @media (max-width: 768px) { .mobile-move { display: block; } }
        .modal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal-content { background-color: #fefefe; padding: 20px; border: 1px solid #888; width: 90%; max-width: 600px; border-radius: 12px; position: relative; max-height: 85vh; display: flex; flex-direction: column; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .close { color: #aaa; position: absolute; right: 15px; top: 10px; font-size: 36px; font-weight: bold; cursor: pointer; z-index: 10; padding: 5px; } .close:hover { color: #000; }
        .manage-section { flex-grow: 1; overflow-y: auto; border-bottom: 2px solid #eee; margin-bottom: 15px; padding-bottom: 10px;} .manage-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 8px; border-bottom: 1px solid #eee; } .manage-item:nth-child(even) { background-color: #fafafa; }
        .batch-add { background: #e3f2fd; padding: 10px; border-radius: 6px; margin-bottom: 15px;} .batch-add textarea { width: 100%; height: 80px; margin-bottom: 10px; padding: 8px; border-radius: 4px; border: 1px solid #90caf9; box-sizing: border-box; font-family: monospace; }
        .single-add { display: flex; gap: 10px; flex-wrap: wrap; background: #f9f9f9; padding: 10px; border-radius: 6px; } .single-add input, .single-add select { padding: 8px; border-radius: 4px; border: 1px solid #ccc; flex-grow: 1; min-width: 100px;}
        textarea.result-box { width: 100%; height: 250px; padding: 10px; border-radius: 8px; border: 1px solid #ccc; font-family: monospace; line-height: 1.5; resize: none; margin-bottom: 10px; box-sizing: border-box;}
        .move-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 10px; overflow-y: auto; max-height: 60vh; }
        .btn-move-option { padding: 15px; font-size: 16px; border: 2px solid var(--border); border-radius: 8px; background: #fff; color: #333; text-align: center; font-weight: bold; transition: all 0.2s; } .btn-move-option:active { background: #e0e0e0; transform: scale(0.98); }
        .btn-move-pool { grid-column: 1 / -1; background-color: #fff3e0; border-color: #ffb74d; color: #e65100; } .btn-move-buoy { background-color: #f8f9fa; }
        #unassigned-area { display: block; background: #fff3e0; border: 2px dashed #ffb74d; margin-bottom: 20px; padding: 15px; border-radius: 12px; min-height: 80px; }
        #unassigned-area .diver-list { display: flex; flex-wrap: wrap; gap: 10px; padding: 0; min-height: 60px; }
        /* åŒæ­¥ç‹€æ…‹æŒ‡ç¤ºç‡ˆ */
        #sync-status { text-align: center; font-size: 0.8em; margin-top: -10px; margin-bottom: 10px; font-weight: bold; color: #666; }
        .status-live { color: #28a745; }
        .status-offline { color: #dc3545; }
    </style>
</head>
<body>

    <h1>è‡ªç”±æ½›æ°´åˆ†é… v15.0</h1>
    <div id="sync-status">ğŸ”µ é€£ç·šåˆå§‹åŒ–ä¸­...</div>

    <div class="controls">
        <button class="btn-manage" type="button" onclick="openManager()">âš™ï¸ ç·¨è¼¯äººå“¡</button>
        <div class="control-group">
            <label>æ¨¡å¼:</label>
            <select id="assignLogic" class="logic-select" onchange="pushSettings()">
                <option value="balance" selected>âš–ï¸ å¹³å‡åˆ†é…</option>
                <option value="group">ğŸ’ èƒ½åŠ›åˆ†çµ„</option>
                <option value="random">ğŸ² éš¨æ©Ÿåˆ†é…</option>
            </select>
        </div>
        
        <div class="control-group">
            <label>çƒæ•¸:</label>
            <div class="stepper">
                <input type="number" id="buoyCount" value="4" min="1" max="20" onchange="pushSettings()">
                <div class="stepper-btns">
                    <button class="stepper-btn" onclick="stepValue('buoyCount', 1)">â–²</button>
                    <button class="stepper-btn" onclick="stepValue('buoyCount', -1)">â–¼</button>
                </div>
            </div>
        </div>

        <div class="control-group">
            <label>ä¸Šé™:</label>
            <div class="stepper">
                <input type="number" id="maxCapacity" value="4" min="1" max="10" onchange="pushSettings()">
                <div class="stepper-btns">
                    <button class="stepper-btn" onclick="stepValue('maxCapacity', 1)">â–²</button>
                    <button class="stepper-btn" onclick="stepValue('maxCapacity', -1)">â–¼</button>
                </div>
            </div>
        </div>

        <button class="btn-primary" type="button" onclick="triggerAutoAssign()">è‡ªå‹•åˆ†é…</button>
        <div style="display:flex; gap:5px;">
            <button class="btn-info" type="button" onclick="openExport()">ğŸ“‹ è¼¸å‡º</button>
        </div>
    </div>

    <div id="unassigned-area">
        <div style="font-weight:bold; color:#e65100; margin-bottom:10px;">å¾…åˆ†é…äººå“¡ (æ‹–æ›³è‡³ä¸‹æ–¹)</div>
        <div class="diver-list" id="pool" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
    </div>

    <div class="buoy-container" id="buoyContainer"></div>

    <div id="managerModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('managerModal')">&times;</span>
            <h2 style="margin-top:0;">äººå“¡è³‡æ–™ç®¡ç†</h2>
            <div class="manage-section">
                <div style="margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
                    <strong>ç›®å‰åå–® (<span id="countDisplay">0</span> äºº)</strong>
                    <button class="btn-danger" type="button" style="font-size:12px;" onclick="clearAll()">æ¸…ç©ºå…¨éƒ¨</button>
                </div>
                <div id="manageList"></div>
            </div>
            <div class="input-section">
                <div class="batch-add">
                    <span style="font-weight:bold; color:#1565c0; display:block; margin-bottom:5px;">ğŸ“ æ‰¹é‡åŒ¯å…¥</span>
                    <textarea id="batchInput" placeholder="æ•™ç·´ ç‹å°æ˜&#10;W3 æå¤§è¯&#10;Newbie å¼µæ–°æ‰‹..."></textarea>
                    <button class="btn-info" type="button" onclick="batchImport()" style="width:100%">è§£æä¸¦åŒ¯å…¥</button>
                </div>
                <div class="single-add">
                    <input type="text" id="newName" placeholder="å§“å">
                    <select id="newRole">
                        <option value="æ•™ç·´|5">æ•™ç·´</option>
                        <option value="A4|4">A4 / W3</option>
                        <option value="A3|3">A3 / W2</option>
                        <option value="A2|2">A2 / W1</option>
                        <option value="Newbie|1">Newbie / ç„¡è­‰</option>
                    </select>
                    <button class="btn-success" type="button" onclick="addNewPerson()" style="flex-grow:2">æ–°å¢</button>
                </div>
            </div>
        </div>
    </div>

    <div id="exportModal" class="modal">
        <div class="modal-content" style="max-height: 600px;">
            <span class="close" onclick="closeModal('exportModal')">&times;</span>
            <h2 style="margin-top:0;">åˆ†é…çµæœ</h2>
            <textarea id="exportText" class="result-box" readonly></textarea>
            <div style="display:flex; gap:10px;">
                <button class="btn-primary" onclick="copyToClipboard()" style="flex:1;">è¤‡è£½</button>
                <button class="btn-reset" onclick="closeModal('exportModal')" style="flex:1;">é—œé–‰</button>
            </div>
        </div>
    </div>

    <div id="moveModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <span class="close" onclick="closeModal('moveModal')">&times;</span>
            <h3 id="moveTargetName" style="margin-top:0; text-align:center;">ç§»å‹•äººå“¡</h3>
            <div id="moveOptions" class="move-grid"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // ğŸ”¥ ä½¿ç”¨è€…æä¾›çš„è¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyCOcefBJVKltX5JxBqr22WY_UnW94RI05o",
            authDomain: "buoy-0539.firebaseapp.com",
            projectId: "buoy-0539",
            storageBucket: "buoy-0539.firebasestorage.app",
            messagingSenderId: "60345079824",
            appId: "1:60345079824:web:cf55992050f8731eb49295",
            measurementId: "G-BVHFW88868"
        };

        let app, db;
        try {
            app = initializeApp(firebaseConfig);
            db = getDatabase(app);
            document.getElementById('sync-status').innerText = "ğŸŸ¢ é›²ç«¯é€£ç·šæˆåŠŸ";
            document.getElementById('sync-status').className = "status-live";
        } catch (e) {
            console.error(e);
            document.getElementById('sync-status').innerText = "ğŸ”´ é€£ç·šå¤±æ•—";
            document.getElementById('sync-status').className = "status-offline";
        }

        // --- å…¨åŸŸè®Šæ•¸ ---
        window.divers = [];
        window.settings = { buoyCount: 4, maxCapacity: 4, logic: 'balance' };
        
        window.pushDivers = pushDivers;
        window.pushSettings = pushSettings;
        window.triggerAutoAssign = triggerAutoAssign;
        window.batchImport = batchImport;
        window.addNewPerson = addNewPerson;
        window.clearAll = clearAll;
        window.deletePerson = deletePerson;
        window.stepValue = stepValue;
        window.drop = drop;
        window.allowDrop = allowDrop;
        window.drag = drag;
        window.toggleLeader = toggleLeader;
        window.showMobileMenu = showMobileMenu;
        window.executeMove = executeMove;
        
        // --- æ ¸å¿ƒï¼šç›£è½é›²ç«¯è³‡æ–™ (Read) ---
        if(db) {
            const dataRef = ref(db, 'freediving_data');
            onValue(dataRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    if (data.settings) {
                        window.settings = data.settings;
                        document.getElementById('buoyCount').value = window.settings.buoyCount;
                        document.getElementById('maxCapacity').value = window.settings.maxCapacity;
                        document.getElementById('assignLogic').value = window.settings.logic;
                    }
                    if (data.divers) {
                        window.divers = data.divers;
                        renderUIFromCloud();
                    } else {
                        window.divers = [];
                        renderUIFromCloud();
                    }
                } else {
                    pushSettings();
                    pushDivers();
                }
            });
        }

        // --- æ ¸å¿ƒï¼šå¯«å…¥é›²ç«¯ (Write) ---
        function pushDivers() {
            if(!db) return;
            set(ref(db, 'freediving_data/divers'), window.divers);
        }

        function pushSettings() {
            if(!db) return;
            window.settings = {
                buoyCount: parseInt(document.getElementById('buoyCount').value),
                maxCapacity: parseInt(document.getElementById('maxCapacity').value),
                logic: document.getElementById('assignLogic').value
            };
            update(ref(db, 'freediving_data/settings'), window.
